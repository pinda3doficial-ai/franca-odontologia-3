<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Desafio Fran√ßa Odontologia - Segunda</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .forca-txt { font-family: 'Courier New', Courier, monospace; letter-spacing: 0.3rem; }
        .membro { display: none; stroke: #1e3a8a; stroke-width: 4; fill: none; }
        .visivel { display: block; }
        .tecla-errada { background-color: #fee2e2 !important; color: #ef4444 !important; opacity: 0.5; cursor: not-allowed; }
        .tecla-certa { background-color: #dcfce7 !important; color: #16a34a !important; }
    </style>
</head>
<body class="bg-blue-50 min-h-screen flex flex-col items-center justify-center p-4">

    <div id="tela-login" class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md text-center border-t-8 border-blue-900">
        <h1 class="text-3xl font-bold text-blue-900 mb-2">ü¶∑ Fran√ßa Odontologia</h1>
        <p class="text-slate-500 mb-6 font-medium">Desafio de Segunda: Jogo da Forca</p>
        
        <input type="text" id="nome" placeholder="Seu Nome Completo" class="w-full border-2 p-3 rounded-xl mb-3 focus:border-blue-500 outline-none">
        <input type="tel" id="whatsapp" placeholder="WhatsApp (DDD + N√∫mero)" class="w-full border-2 p-3 rounded-xl mb-6 focus:border-blue-500 outline-none">
        
        <button onclick="iniciar()" class="bg-blue-900 text-white w-full py-4 rounded-xl font-bold text-lg hover:bg-blue-800 transition shadow-lg">Entrar no Desafio</button>
    </div>

    <div id="tela-jogo" class="hidden bg-white p-6 rounded-2xl shadow-2xl w-full max-w-md text-center">
        <div class="flex justify-between items-center mb-4">
            <span class="text-blue-900 font-bold uppercase text-[10px] tracking-widest">Fran√ßa Odontologia</span>
            <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm font-bold shadow-sm">Vale: <span id="pontos-valendo">10</span> pts</span>
        </div>

        <svg height="140" width="120" class="mx-auto mb-4">
            <line x1="10" y1="130" x2="110" y2="130" style="stroke:#cbd5e1;stroke-width:4" />
            <line x1="30" y1="130" x2="30" y2="10" style="stroke:#475569;stroke-width:4" />
            <line x1="30" y1="10" x2="85" y2="10" style="stroke:#475569;stroke-width:4" />
            <line x1="85" y1="10" x2="85" y2="30" style="stroke:#94a3b8;stroke-width:2" />
            
            <circle id="membro-1" cx="85" cy="45" r="12" class="membro" /> <line id="membro-2" x1="85" y1="57" x2="85" y2="95" class="membro" /> <line id="membro-3" x1="85" y1="65" x2="70" y2="85" class="membro" /> <line id="membro-4" x1="85" y1="65" x2="100" y2="85" class="membro" /> <line id="membro-5" x1="85" y1="95" x2="70" y2="115" class="membro" /> <line id="membro-6" x1="85" y1="95" x2="100" y2="115" class="membro" /> </svg>

        <div id="palavra-display" class="forca-txt text-3xl font-bold text-blue-900 mb-6 uppercase">_ _ _ _ _ _ _</div>
        <p id="dica" class="text-xs text-slate-400 mb-6 italic uppercase tracking-tighter">Dica: Essencial para um sorriso saud√°vel</p>
        
        <div class="grid grid-cols-6 gap-2 mb-4" id="teclado"></div>

        <div id="mensagem" class="hidden border-t pt-4">
            <p id="texto-final" class="font-bold text-lg mb-4"></p>
            <button id="btn-acao" class="bg-blue-900 text-white px-6 py-3 rounded-xl font-bold hover:bg-blue-800 transition w-full shadow-md"></button>
        </div>
    </div>

    <div id="ranking-container" class="hidden mt-6 bg-white p-6 rounded-2xl shadow-xl w-full max-w-md border-b-8 border-blue-900">
        <h3 class="text-blue-900 font-black text-center border-b pb-2 mb-3 tracking-tighter">üèÜ RANKING FRAN√áA ODONTOLOGIA</h3>
        <div id="lista-ranking" class="text-sm space-y-2">
            </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ---------------------------------------------------------
        // INSIRA SEUS DADOS DO FIREBASE AQUI:
        // ---------------------------------------------------------
        const firebaseConfig = {
  apiKey: "AIzaSyCzwQJ1k25R6eSmroZ7mtTbzbMYvJWyHNU",
  authDomain: "franca-odontologia-3.firebaseapp.com",
  projectId: "franca-odontologia-3",
  storageBucket: "franca-odontologia-3.firebasestorage.app",
  messagingSenderId: "838434930814",
  appId: "1:838434930814:web:e2a5c59e68b29605a0d82f"
};
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const palavraCerta = "LIMPEZA";
        let letrasTentadas = [];
        let erros = 0;
        let penalidade = 0;
        let nomePac = "";
        let zapPac = "";

        window.iniciar = function() {
            nomePac = document.getElementById('nome').value.trim();
            zapPac = document.getElementById('whatsapp').value.trim();
            if(!nomePac || !zapPac) return alert("Por favor, preencha nome e WhatsApp!");
            
            document.getElementById('tela-login').classList.add('hidden');
            document.getElementById('tela-jogo').classList.remove('hidden');
            document.getElementById('ranking-container').classList.remove('hidden');
            
            desenharTeclado();
            atualizarDisplay();
            atualizarRankingVisual();
        }

        function desenharTeclado() {
            const teclado = document.getElementById('teclado');
            teclado.innerHTML = "";
            "ABCDEFGHIJLMNOPQRSTUVWXYZ".split('').forEach(l => {
                const btn = document.createElement('button');
                btn.innerText = l;
                btn.className = "bg-slate-100 p-2 rounded-lg font-bold text-slate-700 hover:bg-blue-200 transition text-sm";
                btn.onclick = () => chutar(l, btn);
                teclado.appendChild(btn);
            });
        }

        function chutar(letra, btn) {
            btn.disabled = true;
            if(palavraCerta.includes(letra)) {
                letrasTentadas.push(letra);
                btn.classList.add('tecla-certa');
            } else {
                erros++;
                btn.classList.add('tecla-errada');
                if(erros <= 6) document.getElementById(`membro-${erros}`).classList.add('visivel');
            }
            atualizarDisplay();
        }

        async function atualizarDisplay() {
            let display = "";
            let ganhou = true;
            for(let l of palavraCerta) {
                if(letrasTentadas.includes(l)) { display += l + " "; }
                else { display += "_ "; ganhou = false; }
            }
            document.getElementById('palavra-display').innerText = display;

            if(ganhou) {
                finalizarRodada(true, Math.max(0, 10 - penalidade));
            } else if(erros >= 6) {
                finalizarRodada(false, 0);
            }
        }

        async function finalizarRodada(vitoria, pontos) {
            document.getElementById('teclado').classList.add('pointer-events-none', 'opacity-30');
            document.getElementById('mensagem').classList.remove('hidden');
            const texto = document.getElementById('texto-final');
            const btn = document.getElementById('btn-acao');

            if(vitoria) {
                texto.innerText = `ü•≥ Parab√©ns! Voc√™ ganhou ${pontos} pontos!`;
                texto.className = "font-bold text-green-600 text-lg mb-4 uppercase tracking-tighter";
                btn.innerText = "REGISTRAR MEUS PONTOS";
                btn.onclick = () => salvarNoFirebase(pontos);
            } else {
                texto.innerText = "üòµ Voc√™ foi enforcado!";
                texto.className = "font-bold text-red-600 text-lg mb-4 uppercase";
                btn.innerText = "TENTAR NOVAMENTE (-1 PONTO)";
                btn.onclick = () => resetarJogo();
            }
        }

        async function salvarNoFirebase(pontos) {
            const btn = document.getElementById('btn-acao');
            btn.disabled = true;
            btn.innerText = "VERIFICANDO...";

            try {
                // TRAVA DE SEGURAN√áA: Verifica se j√° jogou hoje
                const hoje = new Date().toLocaleDateString();
                const q = query(collection(db, "pontos"), where("whatsapp", "==", zapPac), where("dataSimples", "==", hoje));
                const querySnapshot = await getDocs(q);

                if(!querySnapshot.empty) {
                    alert("Voc√™ j√° pontuou hoje! Volte amanh√£ para um novo desafio. üòâ");
                    location.reload();
                    return;
                }

                // SALVAMENTO REAL
                await addDoc(collection(db, "pontos"), {
                    nome: nomePac,
                    whatsapp: zapPac,
                    pontos: pontos,
                    jogo: "Segunda-Forca",
                    data: new Date(),
                    dataSimples: hoje
                });

                alert("Pontos salvos com sucesso na Fran√ßa Odontologia!");
                location.reload();

            } catch (e) {
                alert("Erro ao salvar pontos. Tente novamente.");
                btn.disabled = false;
            }
        }

        window.resetarJogo = function() {
            penalidade++;
            erros = 0;
            letrasTentadas = [];
            document.getElementById('pontos-valendo').innerText = Math.max(0, 10 - penalidade);
            document.querySelectorAll('.membro').forEach(m => m.classList.remove('visivel'));
            document.getElementById('teclado').classList.remove('pointer-events-none', 'opacity-30');
            document.getElementById('mensagem').classList.add('hidden');
            desenharTeclado();
            atualizarDisplay();
        }

       async function atualizarRankingVisual() {
    try {
        const q = query(collection(db, "pontos")); // Pega todos os registros
        const querySnapshot = await getDocs(q);
        
        const totaisPorPaciente = {};

        // Soma os pontos de cada WhatsApp
        querySnapshot.forEach((doc) => {
            const d = doc.data();
            const chave = d.whatsapp;
            if (!totaisPorPaciente[chave]) {
                totaisPorPaciente[chave] = { nome: d.nome, pontos: 0 };
            }
            totaisPorPaciente[chave].pontos += d.pontos;
        });

        // Transforma em lista e ordena do maior para o menor
        const rankingOrdenado = Object.values(totaisPorPaciente)
            .sort((a, b) => b.pontos - a.pontos)
            .slice(0, 5); // Pega os top 5

        const lista = document.getElementById('lista-ranking');
        lista.innerHTML = "";
        
        rankingOrdenado.forEach((paci) => {
            lista.innerHTML += `
                <div class="flex justify-between items-center bg-blue-50 p-2 rounded-lg border-l-4 border-blue-900">
                    <span class="font-bold text-slate-700 uppercase text-[10px]">${paci.nome}</span>
                    <span class="bg-blue-900 text-white px-2 py-1 rounded text-[10px] font-black">${paci.pontos} PTS</span>
                </div>`;
        });
    } catch(e) { 
        console.log("Erro ao carregar ranking:", e); 
    }
}
    </script>
</body>
</html>
